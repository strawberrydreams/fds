<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì‹ ë¶„ì¦ ì¸ì¦ - FDS BANK</title>
    <th:block th:replace="~{index :: common_head('FDS BANK - ' + ${title})}"></th:block>
    <style>
        .container { max-width: 500px; margin: 50px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .camera-box { width: 100%; height: 300px; background: #000; border-radius: 12px; margin: 20px 0; position: relative; overflow: hidden; border: 3px solid #007bff; }

        #video, #photoPreview { width: 100%; height: 100%; object-fit: cover; }
        #photoPreview { display: none; background: #fff; }

        .guide-line { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 60%; border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 10px; box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5); pointer-events: none; }

        .btn-capture { width: 70px; height: 70px; background: white; border: 5px solid #007bff; border-radius: 50%; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-capture:active { transform: scale(0.9); }

        .status { margin-top: 15px; font-weight: bold; color: #007bff; min-height: 24px; }
        .loading-spinner { display: none; margin: 10px auto; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .result-area { display: none; margin-top: 20px; text-align: left; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef; }
        .result-area label { font-size: 13px; color: #666; font-weight: bold; display: block; margin-bottom: 5px; }
        .result-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }

        .btn-group { display: flex; gap: 10px; }
        .btn-retry { flex: 1; padding: 12px; background: #eee; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #555; }
        .btn-next { flex: 2; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .manual-area { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ddd; }
        .btn-manual { background: none; border: 1px solid #007bff; color: #007bff; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #canvas { display: none; }
    </style>
</head>
<body>
<div th:replace="~{index :: menu}"></div>

<div class="container">
    <h3>ğŸªª ì‹ ë¶„ì¦ ì´¬ì˜</h3>
    <p id="top-msg" style="font-size: 14px; color: #666;">ì‹ ë¶„ì¦ì„ ê°€ì´ë“œë¼ì¸ì— ë§ì¶°ì£¼ì„¸ìš”.</p>

    <div class="camera-box">
        <video id="video" autoplay playsinline></video>
        <img id="photoPreview" src="" alt="Capture Preview">
        <div id="guide-line" class="guide-line"></div>
    </div>

    <canvas id="canvas"></canvas>

    <div id="status" class="status">ì¹´ë©”ë¼ ì—°ê²° ì¤‘...</div>
    <div id="spinner" class="loading-spinner"></div>

    <button type="button" class="btn-capture" onclick="captureAndAnalyze()" id="captureBtn"></button>

    <div id="resultArea" class="result-area">
        <label>ì¸ì‹ëœ ì„±í•¨</label>
        <input type="text" id="resName" class="result-input">

        <label>ì¸ì‹ëœ ìƒë…„ì›”ì¼</label>
        <input type="text" id="resBirth" class="result-input">

        <div class="btn-group">
            <button type="button" class="btn-retry" onclick="resetCamera()">ë‹¤ì‹œ ì°ê¸°</button>
            <button type="button" class="btn-next" onclick="goToGeneration()">ì´ ì •ë³´ë¡œ ì§„í–‰</button>
        </div>
    </div>

    <div class="manual-area" id="manualArea">
        <p style="font-size: 13px; color: #999; margin-bottom: 10px;">ë¶„ì„ì´ ì˜ ì•ˆ ë˜ë‚˜ìš”?</p>
        <button type="button" class="btn-manual" onclick="location.href='/account/generation'">ì§ì ‘ ì •ë³´ ì…ë ¥í•˜ê¸°</button>
    </div>
</div>

<script th:inline="javascript">
    const video = document.getElementById('video');
    const photoPreview = document.getElementById('photoPreview');
    const guideLine = document.getElementById('guide-line');
    const status = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const captureBtn = document.getElementById('captureBtn');
    const resultArea = document.getElementById('resultArea');
    const manualArea = document.getElementById('manualArea');

    let localStream = null;

    // 1. ì¹´ë©”ë¼ ì‹œì‘
    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280, height: 720 } })
            .then(stream => {
                localStream = stream;
                video.srcObject = stream;
                status.innerText = "ê°€ì´ë“œë¼ì¸ì— ë§ì¶° ì´¬ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                console.log("âœ… ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘");
            })
            .catch(err => {
                status.innerText = "ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                console.error("âŒ ì¹´ë©”ë¼ ì—ëŸ¬:", err);
            });
    }

    startCamera();

    // 2. ì´¬ì˜ ë° ë¶„ì„
    async function captureAndAnalyze() {
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL('image/jpeg', 1.0);
        console.log("ğŸ“¸ ì´ë¯¸ì§€ ìº¡ì²˜ ì™„ë£Œ");

        status.innerText = "Google AI ë¶„ì„ ì¤‘...";
        spinner.style.display = "block";
        captureBtn.style.display = "none";
        manualArea.style.display = "none";

        try {
            const response = await fetch('/account/ocr-api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ 'imageDate': imageData })
            });

            if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");

            const data = await response.json();
            console.log("ğŸ“¡ ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ :");
            console.table(data); // F12 ì½˜ì†”ì—ì„œ ë°ì´í„° í™•ì¸ ê°€ëŠ¥

            // ì„±ê³µ ì‹œ ì¹´ë©”ë¼ ì •ì§€ (ìì› í•´ì œ)
            stopCamera();
            showResultView(imageData, data.name, data.birth);

        } catch (err) {
            console.error("âŒ ë¶„ì„ ì¤‘ ì—ëŸ¬ ë°œìƒ:", err);
            alert("ì •ë³´ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            resetCamera();
        }
    }

    // 3. ê²°ê³¼ ë·° ì „í™˜
    function showResultView(image, name, birth) {
        spinner.style.display = "none";
        status.innerText = "ì¸ì‹ëœ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        document.getElementById('top-msg').innerText = "ì¸ì‹ ê²°ê³¼ê°€ í‹€ë¦¬ë‹¤ë©´ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";

        video.style.display = "none";
        guideLine.style.display = "none";
        photoPreview.src = image;
        photoPreview.style.display = "block";

        // ì„œë²„ì—ì„œ ì˜¨ ë°ì´í„° ë§¤í•‘ (undefined ë°©ì§€)
        document.getElementById('resName').value = name || "ë¯¸ì¸ì‹";
        document.getElementById('resBirth').value = birth || "ë¯¸ì¸ì‹";

        resultArea.style.display = "block";
    }

    // 4. ì¹´ë©”ë¼ ì •ì§€ í•¨ìˆ˜
    function stopCamera() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            console.log("ğŸ”Œ ì¹´ë©”ë¼ ìì› í•´ì œ ì™„ë£Œ");
        }
    }

    // 5. ë‹¤ì‹œ ì°ê¸°
    function resetCamera() {
        stopCamera();
        location.reload();
    }

    // 6. ë‹¤ìŒ ë‹¨ê³„ ì´ë™
    function goToGeneration() {
        const finalName = document.getElementById('resName').value;
        const finalBirth = document.getElementById('resBirth').value;

        console.log("ğŸš€ ìµœì¢… ë°ì´í„° ì „ì†¡:", { finalName, finalBirth });

        // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì´ë¦„ì„ generation.htmlê³¼ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë°›ëŠ” ì´ë¦„ì— ë§ì¶¤
        location.href = `/account/generation?userName=${encodeURIComponent(finalName)}&userBirth=${encodeURIComponent(finalBirth)}`;
    }
</script>
</body>
</html>